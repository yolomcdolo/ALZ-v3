name: Validate Bicep Templates

on:
  pull_request:
    branches: [main]
    paths:
      - 'bicep/**'
      - '.github/workflows/validate-bicep.yml'
  push:
    branches: [main]
    paths:
      - 'bicep/**'

jobs:
  validate:
    name: Validate Bicep
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Setup Bicep
        run: |
          az bicep install
          az bicep version

      - name: Lint Bicep files
        run: |
          echo "## Bicep Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          ERRORS=0

          for file in $(find bicep -name "*.bicep" 2>/dev/null); do
            echo "Validating: $file"
            if az bicep build --file $file --stdout > /dev/null 2>&1; then
              echo "- $file: PASS" >> $GITHUB_STEP_SUMMARY
            else
              echo "- $file: FAIL" >> $GITHUB_STEP_SUMMARY
              ERRORS=$((ERRORS + 1))
            fi
          done

          if [ $ERRORS -gt 0 ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Total errors: $ERRORS" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All Bicep files validated successfully!" >> $GITHUB_STEP_SUMMARY

      - name: Run what-if (dry run)
        if: github.event_name == 'pull_request'
        run: |
          echo "Running what-if analysis..."
          # This would run az deployment what-if on main template
          # Skipped if no main.bicep exists
          if [ -f "bicep/main.bicep" ]; then
            az deployment sub what-if \
              --location eastus \
              --template-file bicep/main.bicep \
              --parameters bicep/parameters/prod.parameters.json
          fi
