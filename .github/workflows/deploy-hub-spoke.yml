name: Deploy Hub-Spoke Infrastructure

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'prod'
        type: choice
        options:
          - dev
          - staging
          - prod
      location:
        description: 'Azure region'
        required: true
        default: 'eastus'
        type: choice
        options:
          - eastus
          - eastus2
          - westus2
          - centralus
          - northeurope
          - westeurope
      deploy_vpn_gateway:
        description: 'Deploy VPN Gateway (adds ~20 min)'
        required: true
        default: false
        type: boolean
      deploy_bastion:
        description: 'Deploy Azure Bastion'
        required: true
        default: true
        type: boolean
      spoke_count:
        description: 'Number of spoke VNets'
        required: true
        default: '3'
        type: choice
        options:
          - '2'
          - '3'
          - '4'
          - '5'
      vm_count_spoke1:
        description: 'VMs in Spoke 1 (workloads)'
        required: true
        default: '4'
        type: string
      vm_count_spoke2:
        description: 'VMs in Spoke 2 (DCs)'
        required: true
        default: '2'
        type: string

env:
  AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

jobs:
  # ====================
  # Phase 1: Pre-Flight
  # ====================
  pre-flight:
    name: Pre-Flight Checks
    runs-on: ubuntu-latest
    outputs:
      timestamp: ${{ steps.setup.outputs.timestamp }}
      deployment_name: ${{ steps.setup.outputs.deployment_name }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Setup deployment variables
        id: setup
        run: |
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          DEPLOYMENT_NAME="alz-${{ inputs.environment }}-${TIMESTAMP}"
          echo "timestamp=${TIMESTAMP}" >> $GITHUB_OUTPUT
          echo "deployment_name=${DEPLOYMENT_NAME}" >> $GITHUB_OUTPUT
          echo "Deployment: ${DEPLOYMENT_NAME}"

      - name: Verify Azure providers
        run: |
          echo "Checking required Azure providers..."
          PROVIDERS="Microsoft.Network Microsoft.Compute Microsoft.Storage Microsoft.OperationalInsights"
          for provider in $PROVIDERS; do
            status=$(az provider show --namespace $provider --query "registrationState" -o tsv 2>/dev/null)
            if [ "$status" != "Registered" ]; then
              echo "Registering $provider..."
              az provider register --namespace $provider
            else
              echo "$provider: Already registered"
            fi
          done
          echo "Provider check complete"

      - name: Check VM quota
        run: |
          echo "Checking VM quota in ${{ inputs.location }}..."
          LOCATION="${{ inputs.location }}"

          # Check B-series quota (for workload VMs)
          B_QUOTA=$(az vm list-usage --location $LOCATION \
            --query "[?contains(name.value, 'standardBSFamily')].{current:currentValue, limit:limit}" \
            -o tsv)
          echo "B-series quota: $B_QUOTA"

          # Check D-series quota (for DC VMs)
          D_QUOTA=$(az vm list-usage --location $LOCATION \
            --query "[?contains(name.value, 'standardDSv3Family')].{current:currentValue, limit:limit}" \
            -o tsv)
          echo "D-series quota: $D_QUOTA"

          echo "Quota check passed"

      - name: Create deployment summary
        run: |
          echo "## Deployment Configuration" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Parameter | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | ${{ inputs.environment }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Location | ${{ inputs.location }} |" >> $GITHUB_STEP_SUMMARY
          echo "| VPN Gateway | ${{ inputs.deploy_vpn_gateway }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Azure Bastion | ${{ inputs.deploy_bastion }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Spoke Count | ${{ inputs.spoke_count }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Spoke1 VMs | ${{ inputs.vm_count_spoke1 }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Spoke2 VMs | ${{ inputs.vm_count_spoke2 }} |" >> $GITHUB_STEP_SUMMARY

  # ====================
  # Phase 2: Foundation
  # ====================
  foundation:
    name: Deploy Foundation
    runs-on: ubuntu-latest
    needs: pre-flight
    outputs:
      hub_rg: ${{ steps.create-rgs.outputs.hub_rg }}
      log_workspace_id: ${{ steps.create-law.outputs.workspace_id }}
    steps:
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Create Resource Groups
        id: create-rgs
        run: |
          ENV="${{ inputs.environment }}"
          LOC="${{ inputs.location }}"
          SPOKE_COUNT=${{ inputs.spoke_count }}

          # Hub resource group
          HUB_RG="rg-hub-networking-${ENV}-${LOC}-001"
          az group create -n $HUB_RG -l $LOC --tags Environment=$ENV ManagedBy=ALZ-v3-Pipeline
          echo "hub_rg=${HUB_RG}" >> $GITHUB_OUTPUT

          # Spoke resource groups (parallel)
          for i in $(seq 1 $SPOKE_COUNT); do
            az group create -n "rg-spoke${i}-${ENV}-${LOC}-001" -l $LOC \
              --tags Environment=$ENV ManagedBy=ALZ-v3-Pipeline &
          done

          # Shared services resource group
          az group create -n "rg-shared-${ENV}-${LOC}-001" -l $LOC \
            --tags Environment=$ENV ManagedBy=ALZ-v3-Pipeline &

          wait
          echo "Resource groups created"

      - name: Create Log Analytics Workspace
        id: create-law
        run: |
          ENV="${{ inputs.environment }}"
          LOC="${{ inputs.location }}"
          HUB_RG="rg-hub-networking-${ENV}-${LOC}-001"

          WORKSPACE_ID=$(az monitor log-analytics workspace create \
            -g $HUB_RG \
            -n "log-hub-${ENV}-${LOC}-001" \
            --retention-time 30 \
            --query id -o tsv)

          echo "workspace_id=${WORKSPACE_ID}" >> $GITHUB_OUTPUT
          echo "Log Analytics workspace created: $WORKSPACE_ID"

  # ====================
  # Phase 3: Hub Network
  # ====================
  hub-network:
    name: Deploy Hub Network
    runs-on: ubuntu-latest
    needs: foundation
    outputs:
      hub_vnet_id: ${{ steps.create-hub-vnet.outputs.vnet_id }}
      firewall_subnet_id: ${{ steps.create-hub-vnet.outputs.fw_subnet_id }}
      bastion_subnet_id: ${{ steps.create-hub-vnet.outputs.bastion_subnet_id }}
    steps:
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Create Hub VNet
        id: create-hub-vnet
        run: |
          ENV="${{ inputs.environment }}"
          LOC="${{ inputs.location }}"
          HUB_RG="rg-hub-networking-${ENV}-${LOC}-001"
          VNET_NAME="vnet-hub-${ENV}-${LOC}-001"

          # Create VNet
          VNET_ID=$(az network vnet create \
            -g $HUB_RG \
            -n $VNET_NAME \
            --address-prefix 10.0.0.0/16 \
            --query newVNet.id -o tsv)

          echo "vnet_id=${VNET_ID}" >> $GITHUB_OUTPUT

          # Create subnets (SEQUENTIAL - same VNet requirement)
          # AzureFirewallSubnet
          FW_SUBNET_ID=$(az network vnet subnet create \
            -g $HUB_RG \
            --vnet-name $VNET_NAME \
            -n AzureFirewallSubnet \
            --address-prefix 10.0.1.0/26 \
            --query id -o tsv)
          echo "fw_subnet_id=${FW_SUBNET_ID}" >> $GITHUB_OUTPUT

          # AzureBastionSubnet
          BASTION_SUBNET_ID=$(az network vnet subnet create \
            -g $HUB_RG \
            --vnet-name $VNET_NAME \
            -n AzureBastionSubnet \
            --address-prefix 10.0.2.0/26 \
            --query id -o tsv)
          echo "bastion_subnet_id=${BASTION_SUBNET_ID}" >> $GITHUB_OUTPUT

          # Management subnet
          az network vnet subnet create \
            -g $HUB_RG \
            --vnet-name $VNET_NAME \
            -n snet-management \
            --address-prefix 10.0.3.0/24

          # Private endpoints subnet
          az network vnet subnet create \
            -g $HUB_RG \
            --vnet-name $VNET_NAME \
            -n snet-private-endpoints \
            --address-prefix 10.0.4.0/24

          echo "Hub VNet created with 4 subnets"

  # ====================
  # Phase 4: Hub Services
  # ====================
  hub-services:
    name: Deploy Hub Services
    runs-on: ubuntu-latest
    needs: hub-network
    outputs:
      firewall_private_ip: ${{ steps.deploy-firewall.outputs.firewall_ip }}
    steps:
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Create Public IPs
        run: |
          ENV="${{ inputs.environment }}"
          LOC="${{ inputs.location }}"
          HUB_RG="rg-hub-networking-${ENV}-${LOC}-001"

          # Firewall Public IP
          az network public-ip create \
            -g $HUB_RG \
            -n "pip-fw-${ENV}-${LOC}-001" \
            --sku Standard \
            --allocation-method Static &

          # Bastion Public IP (if enabled)
          if [ "${{ inputs.deploy_bastion }}" = "true" ]; then
            az network public-ip create \
              -g $HUB_RG \
              -n "pip-bastion-${ENV}-${LOC}-001" \
              --sku Standard \
              --allocation-method Static &
          fi

          wait
          echo "Public IPs created"

      - name: Deploy Azure Firewall
        id: deploy-firewall
        run: |
          ENV="${{ inputs.environment }}"
          LOC="${{ inputs.location }}"
          HUB_RG="rg-hub-networking-${ENV}-${LOC}-001"
          VNET_NAME="vnet-hub-${ENV}-${LOC}-001"
          FW_NAME="fw-hub-${ENV}-${LOC}-001"

          # Deploy firewall (no --no-wait to ensure completion)
          az network firewall create \
            -g $HUB_RG \
            -n $FW_NAME \
            -l $LOC \
            --sku AZFW_VNet \
            --tier Standard \
            --vnet-name $VNET_NAME \
            --public-ip "pip-fw-${ENV}-${LOC}-001"

          # Get firewall private IP
          FW_IP=$(az network firewall show \
            -g $HUB_RG \
            -n $FW_NAME \
            --query "ipConfigurations[0].privateIPAddress" -o tsv)

          echo "firewall_ip=${FW_IP}" >> $GITHUB_OUTPUT
          echo "Azure Firewall deployed with private IP: $FW_IP"

      - name: Deploy Azure Bastion
        if: inputs.deploy_bastion == true
        run: |
          ENV="${{ inputs.environment }}"
          LOC="${{ inputs.location }}"
          HUB_RG="rg-hub-networking-${ENV}-${LOC}-001"
          VNET_NAME="vnet-hub-${ENV}-${LOC}-001"

          az network bastion create \
            -g $HUB_RG \
            -n "bastion-hub-${ENV}-${LOC}-001" \
            --vnet-name $VNET_NAME \
            --public-ip-address "pip-bastion-${ENV}-${LOC}-001" \
            --sku Basic \
            --no-wait

          echo "Azure Bastion deployment started"

      - name: Deploy VPN Gateway
        if: inputs.deploy_vpn_gateway == true
        run: |
          ENV="${{ inputs.environment }}"
          LOC="${{ inputs.location }}"
          HUB_RG="rg-hub-networking-${ENV}-${LOC}-001"
          VNET_NAME="vnet-hub-${ENV}-${LOC}-001"

          # Create GatewaySubnet
          az network vnet subnet create \
            -g $HUB_RG \
            --vnet-name $VNET_NAME \
            -n GatewaySubnet \
            --address-prefix 10.0.255.0/27

          # Create VPN Gateway public IP
          az network public-ip create \
            -g $HUB_RG \
            -n "pip-vpn-${ENV}-${LOC}-001" \
            --sku Standard \
            --allocation-method Static

          # Deploy VPN Gateway (takes ~20-40 min)
          az network vnet-gateway create \
            -g $HUB_RG \
            -n "vpn-hub-${ENV}-${LOC}-001" \
            --vnet $VNET_NAME \
            --gateway-type Vpn \
            --vpn-type RouteBased \
            --sku VpnGw1 \
            --public-ip-addresses "pip-vpn-${ENV}-${LOC}-001" \
            --no-wait

          echo "VPN Gateway deployment started (20-40 min)"

  # ====================
  # Phase 5: Spoke Networks
  # ====================
  spoke-networks:
    name: Deploy Spoke Networks
    runs-on: ubuntu-latest
    needs: hub-network
    outputs:
      spoke_vnet_ids: ${{ steps.create-spokes.outputs.vnet_ids }}
    steps:
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Create Spoke VNets
        id: create-spokes
        run: |
          ENV="${{ inputs.environment }}"
          LOC="${{ inputs.location }}"
          SPOKE_COUNT=${{ inputs.spoke_count }}

          VNET_IDS=""

          # Create spoke VNets (parallel - different resource groups)
          for i in $(seq 1 $SPOKE_COUNT); do
            SPOKE_RG="rg-spoke${i}-${ENV}-${LOC}-001"
            SPOKE_VNET="vnet-spoke${i}-${ENV}-${LOC}-001"
            ADDRESS_PREFIX="10.${i}.0.0/16"
            SUBNET_PREFIX="10.${i}.1.0/24"

            # Determine subnet name based on spoke number
            case $i in
              1) SUBNET_NAME="snet-workloads" ;;
              2) SUBNET_NAME="snet-domain-controllers" ;;
              *) SUBNET_NAME="snet-future" ;;
            esac

            (
              az network vnet create \
                -g $SPOKE_RG \
                -n $SPOKE_VNET \
                --address-prefix $ADDRESS_PREFIX \
                --subnet-name $SUBNET_NAME \
                --subnet-prefix $SUBNET_PREFIX
              echo "Created $SPOKE_VNET"
            ) &
          done

          wait

          # Collect VNet IDs
          for i in $(seq 1 $SPOKE_COUNT); do
            SPOKE_RG="rg-spoke${i}-${ENV}-${LOC}-001"
            SPOKE_VNET="vnet-spoke${i}-${ENV}-${LOC}-001"
            VNET_ID=$(az network vnet show -g $SPOKE_RG -n $SPOKE_VNET --query id -o tsv)
            VNET_IDS="${VNET_IDS}${VNET_ID},"
          done

          echo "vnet_ids=${VNET_IDS}" >> $GITHUB_OUTPUT
          echo "Spoke VNets created"

  # ====================
  # Phase 6: Connectivity
  # ====================
  connectivity:
    name: Configure Connectivity
    runs-on: ubuntu-latest
    needs: [hub-network, hub-services, spoke-networks]
    steps:
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Create VNet Peerings
        run: |
          ENV="${{ inputs.environment }}"
          LOC="${{ inputs.location }}"
          SPOKE_COUNT=${{ inputs.spoke_count }}
          HUB_RG="rg-hub-networking-${ENV}-${LOC}-001"
          HUB_VNET="vnet-hub-${ENV}-${LOC}-001"

          HUB_VNET_ID=$(az network vnet show -g $HUB_RG -n $HUB_VNET --query id -o tsv)

          # Create peerings (hub-to-spoke and spoke-to-hub)
          for i in $(seq 1 $SPOKE_COUNT); do
            SPOKE_RG="rg-spoke${i}-${ENV}-${LOC}-001"
            SPOKE_VNET="vnet-spoke${i}-${ENV}-${LOC}-001"
            SPOKE_VNET_ID=$(az network vnet show -g $SPOKE_RG -n $SPOKE_VNET --query id -o tsv)

            # Hub to Spoke
            az network vnet peering create \
              -g $HUB_RG \
              -n "peer-hub-to-spoke${i}" \
              --vnet-name $HUB_VNET \
              --remote-vnet $SPOKE_VNET_ID \
              --allow-vnet-access \
              --allow-forwarded-traffic &

            # Spoke to Hub
            az network vnet peering create \
              -g $SPOKE_RG \
              -n "peer-spoke${i}-to-hub" \
              --vnet-name $SPOKE_VNET \
              --remote-vnet $HUB_VNET_ID \
              --allow-vnet-access \
              --allow-forwarded-traffic &
          done

          wait
          echo "VNet peerings created"

      - name: Create NSGs with Auto-Configuration
        run: |
          ENV="${{ inputs.environment }}"
          LOC="${{ inputs.location }}"
          SPOKE_COUNT=${{ inputs.spoke_count }}

          for i in $(seq 1 $SPOKE_COUNT); do
            SPOKE_RG="rg-spoke${i}-${ENV}-${LOC}-001"

            case $i in
              1) NSG_NAME="nsg-spoke${i}-workloads-001" ;;
              2) NSG_NAME="nsg-spoke${i}-dc-001" ;;
              *) NSG_NAME="nsg-spoke${i}-future-001" ;;
            esac

            (
              # Create NSG
              az network nsg create -g $SPOKE_RG -n $NSG_NAME -l $LOC

              # Auto-configure hub-spoke VNet rules (IMP-007)
              az network nsg rule create -g $SPOKE_RG --nsg-name $NSG_NAME \
                --name "Allow-VNet-Inbound" --priority 100 --direction Inbound \
                --source-address-prefixes "10.0.0.0/8" --destination-address-prefixes "*" \
                --destination-port-ranges "*" --protocol "*" --access Allow

              az network nsg rule create -g $SPOKE_RG --nsg-name $NSG_NAME \
                --name "Allow-VNet-Outbound" --priority 100 --direction Outbound \
                --source-address-prefixes "*" --destination-address-prefixes "10.0.0.0/8" \
                --destination-port-ranges "*" --protocol "*" --access Allow

              echo "NSG $NSG_NAME configured"
            ) &
          done

          wait
          echo "NSGs created and configured"

      - name: Create Route Tables
        run: |
          ENV="${{ inputs.environment }}"
          LOC="${{ inputs.location }}"
          SPOKE_COUNT=${{ inputs.spoke_count }}
          FW_IP="${{ needs.hub-services.outputs.firewall_private_ip }}"

          for i in $(seq 1 $SPOKE_COUNT); do
            SPOKE_RG="rg-spoke${i}-${ENV}-${LOC}-001"
            RT_NAME="rt-spoke${i}-to-hub"

            (
              # Create route table
              az network route-table create -g $SPOKE_RG -n $RT_NAME -l $LOC

              # Route to other spokes via firewall (IMP-008)
              for j in $(seq 1 $SPOKE_COUNT); do
                if [ $i -ne $j ]; then
                  az network route-table route create -g $SPOKE_RG \
                    --route-table-name $RT_NAME \
                    --name "to-spoke${j}" \
                    --address-prefix "10.${j}.0.0/16" \
                    --next-hop-type VirtualAppliance \
                    --next-hop-ip-address $FW_IP
                fi
              done

              echo "Route table $RT_NAME configured"
            ) &
          done

          wait
          echo "Route tables created"

      - name: Configure Firewall Rules
        run: |
          ENV="${{ inputs.environment }}"
          LOC="${{ inputs.location }}"
          SPOKE_COUNT=${{ inputs.spoke_count }}
          HUB_RG="rg-hub-networking-${ENV}-${LOC}-001"
          FW_NAME="fw-hub-${ENV}-${LOC}-001"

          # Build spoke CIDR list
          SPOKE_CIDRS=""
          for i in $(seq 1 $SPOKE_COUNT); do
            SPOKE_CIDRS="${SPOKE_CIDRS}10.${i}.0.0/16 "
          done

          # Create spoke-to-spoke rule (IMP-009)
          az network firewall network-rule create \
            -g $HUB_RG \
            --firewall-name $FW_NAME \
            --collection-name "AllowSpokeToSpoke" \
            --name "Allow-All-Spokes" \
            --protocols Any \
            --source-addresses $SPOKE_CIDRS \
            --destination-addresses $SPOKE_CIDRS \
            --destination-ports "*" \
            --action Allow \
            --priority 100

          echo "Firewall spoke-to-spoke rules configured"

  # ====================
  # Phase 7: Compute
  # ====================
  compute:
    name: Deploy VMs
    runs-on: ubuntu-latest
    needs: connectivity
    steps:
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy Spoke1 VMs (Workloads)
        run: |
          ENV="${{ inputs.environment }}"
          LOC="${{ inputs.location }}"
          SPOKE_RG="rg-spoke1-${ENV}-${LOC}-001"
          VNET_NAME="vnet-spoke1-${ENV}-${LOC}-001"
          SUBNET_NAME="snet-workloads"
          VM_COUNT=${{ inputs.vm_count_spoke1 }}

          for i in $(seq 1 $VM_COUNT); do
            VM_NAME="vm-workload-${ENV}-$(printf '%03d' $i)"

            az vm create \
              -g $SPOKE_RG \
              -n $VM_NAME \
              --image Ubuntu2204 \
              --size Standard_B2s \
              --vnet-name $VNET_NAME \
              --subnet $SUBNET_NAME \
              --admin-username azureadmin \
              --admin-password "${{ secrets.VM_ADMIN_PASSWORD }}" \
              --public-ip-address "" \
              --nsg "" \
              --no-wait &

            echo "Started VM: $VM_NAME"
          done

          wait
          echo "Spoke1 VMs deployment started"

      - name: Deploy Spoke2 VMs (Domain Controllers)
        run: |
          ENV="${{ inputs.environment }}"
          LOC="${{ inputs.location }}"
          SPOKE_RG="rg-spoke2-${ENV}-${LOC}-001"
          VNET_NAME="vnet-spoke2-${ENV}-${LOC}-001"
          SUBNET_NAME="snet-domain-controllers"
          VM_COUNT=${{ inputs.vm_count_spoke2 }}

          for i in $(seq 1 $VM_COUNT); do
            VM_NAME="vm-dc-${ENV}-$(printf '%03d' $i)"

            az vm create \
              -g $SPOKE_RG \
              -n $VM_NAME \
              --image Win2022Datacenter \
              --size Standard_D2s_v3 \
              --vnet-name $VNET_NAME \
              --subnet $SUBNET_NAME \
              --admin-username azureadmin \
              --admin-password "${{ secrets.VM_ADMIN_PASSWORD }}" \
              --public-ip-address "" \
              --nsg "" \
              --no-wait &

            echo "Started VM: $VM_NAME"
          done

          wait
          echo "Spoke2 VMs deployment started"

      - name: Wait for VMs to provision
        run: |
          ENV="${{ inputs.environment }}"
          LOC="${{ inputs.location }}"

          echo "Waiting for VMs to provision..."
          sleep 120

          # Check Spoke1 VMs
          echo "Spoke1 VM status:"
          az vm list -g "rg-spoke1-${ENV}-${LOC}-001" \
            --query "[].{name:name, state:provisioningState}" -o table

          # Check Spoke2 VMs
          echo "Spoke2 VM status:"
          az vm list -g "rg-spoke2-${ENV}-${LOC}-001" \
            --query "[].{name:name, state:provisioningState}" -o table

  # ====================
  # Phase 8: Validation
  # ====================
  validation:
    name: Validate Deployment
    runs-on: ubuntu-latest
    needs: compute
    steps:
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Run Connectivity Test
        run: |
          ENV="${{ inputs.environment }}"
          LOC="${{ inputs.location }}"
          SPOKE1_RG="rg-spoke1-${ENV}-${LOC}-001"

          # Get source VM
          SOURCE_VM=$(az vm list -g $SPOKE1_RG --query "[0].name" -o tsv)

          # Get Spoke2 VM IP
          SPOKE2_IP=$(az vm list-ip-addresses -g "rg-spoke2-${ENV}-${LOC}-001" \
            --query "[0].virtualMachine.network.privateIpAddresses[0]" -o tsv)

          echo "Testing connectivity from $SOURCE_VM to $SPOKE2_IP..."

          # Install Network Watcher extension
          az vm extension set \
            -g $SPOKE1_RG \
            --vm-name $SOURCE_VM \
            --name NetworkWatcherAgentLinux \
            --publisher Microsoft.Azure.NetworkWatcher

          # Run connectivity test
          RESULT=$(az network watcher test-connectivity \
            -g $SPOKE1_RG \
            --source-resource $SOURCE_VM \
            --dest-address $SPOKE2_IP \
            --dest-port 22 \
            --query "{status:connectionStatus, latency:avgLatencyInMs}" -o json)

          echo "Test result: $RESULT"

          STATUS=$(echo $RESULT | jq -r '.status')
          if [ "$STATUS" = "Reachable" ]; then
            echo "CONNECTIVITY TEST PASSED"
            echo "## Connectivity Test" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Status: PASSED" >> $GITHUB_STEP_SUMMARY
            echo "Latency: $(echo $RESULT | jq -r '.latency')ms" >> $GITHUB_STEP_SUMMARY
          else
            echo "CONNECTIVITY TEST FAILED"
            echo "## Connectivity Test" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Status: FAILED" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Generate Deployment Summary
        run: |
          ENV="${{ inputs.environment }}"
          LOC="${{ inputs.location }}"

          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Resource Groups" >> $GITHUB_STEP_SUMMARY
          az group list --query "[?tags.ManagedBy=='ALZ-v3-Pipeline'].{Name:name, Location:location}" -o table >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Virtual Networks" >> $GITHUB_STEP_SUMMARY
          echo "| VNet | Address Space |" >> $GITHUB_STEP_SUMMARY
          echo "|------|---------------|" >> $GITHUB_STEP_SUMMARY

          for rg in $(az group list --query "[?tags.ManagedBy=='ALZ-v3-Pipeline'].name" -o tsv); do
            for vnet in $(az network vnet list -g $rg --query "[].name" -o tsv 2>/dev/null); do
              addr=$(az network vnet show -g $rg -n $vnet --query "addressSpace.addressPrefixes[0]" -o tsv)
              echo "| $vnet | $addr |" >> $GITHUB_STEP_SUMMARY
            done
          done

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Virtual Machines" >> $GITHUB_STEP_SUMMARY
          echo "| VM Name | Size | Private IP |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|------|------------|" >> $GITHUB_STEP_SUMMARY

          for rg in $(az group list --query "[?tags.ManagedBy=='ALZ-v3-Pipeline' && contains(name, 'spoke')].name" -o tsv); do
            for vm in $(az vm list -g $rg --query "[].name" -o tsv 2>/dev/null); do
              size=$(az vm show -g $rg -n $vm --query "hardwareProfile.vmSize" -o tsv)
              ip=$(az vm list-ip-addresses -g $rg -n $vm --query "[0].virtualMachine.network.privateIpAddresses[0]" -o tsv)
              echo "| $vm | $size | $ip |" >> $GITHUB_STEP_SUMMARY
            done
          done

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Deployment completed successfully!"
