name: Destroy Infrastructure

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment to destroy'
        required: true
        default: 'prod'
        type: choice
        options:
          - dev
          - staging
          - prod
      location:
        description: 'Azure region'
        required: true
        default: 'eastus'
        type: choice
        options:
          - eastus
          - eastus2
          - westus2
          - centralus
          - northeurope
          - westeurope
      confirm_destroy:
        description: 'Type "DESTROY" to confirm deletion'
        required: true
        type: string

jobs:
  validate:
    name: Validate Destruction Request
    runs-on: ubuntu-latest
    outputs:
      confirmed: ${{ steps.check.outputs.confirmed }}
    steps:
      - name: Check confirmation
        id: check
        run: |
          if [ "${{ inputs.confirm_destroy }}" = "DESTROY" ]; then
            echo "confirmed=true" >> $GITHUB_OUTPUT
            echo "Destruction confirmed"
          else
            echo "confirmed=false" >> $GITHUB_OUTPUT
            echo "ERROR: Type 'DESTROY' to confirm"
            exit 1
          fi

  destroy:
    name: Destroy All Resources
    runs-on: ubuntu-latest
    needs: validate
    if: needs.validate.outputs.confirmed == 'true'
    steps:
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: List resources to destroy
        run: |
          ENV="${{ inputs.environment }}"
          LOC="${{ inputs.location }}"

          echo "## Resources to Destroy" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Resource Group | Resources |" >> $GITHUB_STEP_SUMMARY
          echo "|----------------|-----------|" >> $GITHUB_STEP_SUMMARY

          for rg in $(az group list --query "[?tags.ManagedBy=='ALZ-v3-Pipeline' && tags.Environment=='${ENV}'].name" -o tsv); do
            count=$(az resource list -g $rg --query "length(@)" -o tsv 2>/dev/null || echo "0")
            echo "| $rg | $count |" >> $GITHUB_STEP_SUMMARY
          done

      - name: Delete resource groups
        run: |
          ENV="${{ inputs.environment }}"
          LOC="${{ inputs.location }}"

          echo "Starting destruction of environment: $ENV in $LOC"

          # Find all resource groups with ALZ-v3-Pipeline tag
          RESOURCE_GROUPS=$(az group list \
            --query "[?tags.ManagedBy=='ALZ-v3-Pipeline' && tags.Environment=='${ENV}'].name" \
            -o tsv)

          if [ -z "$RESOURCE_GROUPS" ]; then
            echo "No resource groups found to destroy"
            exit 0
          fi

          # Delete in parallel
          for rg in $RESOURCE_GROUPS; do
            echo "Deleting resource group: $rg"
            az group delete -n $rg --yes --no-wait &
          done

          wait
          echo "Deletion initiated for all resource groups"

      - name: Wait for deletion
        run: |
          ENV="${{ inputs.environment }}"

          echo "Waiting for resource groups to be deleted..."

          MAX_WAIT=600  # 10 minutes
          ELAPSED=0

          while [ $ELAPSED -lt $MAX_WAIT ]; do
            REMAINING=$(az group list \
              --query "[?tags.ManagedBy=='ALZ-v3-Pipeline' && tags.Environment=='${ENV}'].name" \
              -o tsv | wc -l)

            if [ "$REMAINING" -eq 0 ]; then
              echo "All resource groups deleted successfully"
              echo "## Destruction Complete" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "All resources have been deleted." >> $GITHUB_STEP_SUMMARY
              exit 0
            fi

            echo "Waiting... $REMAINING resource groups remaining"
            sleep 30
            ELAPSED=$((ELAPSED + 30))
          done

          echo "WARNING: Some resource groups may still be deleting"
          echo "Remaining: $(az group list --query "[?tags.ManagedBy=='ALZ-v3-Pipeline' && tags.Environment=='${ENV}'].name" -o tsv)"
